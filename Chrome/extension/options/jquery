$( function() {
    $('input').each( function( idx, input ) {
        var $input = $(input)
        $input.val( localStorage[ $input.attr( 'name' ) ] )
    } )
  
    function save() {
        var status = ""
        $('input').each( function( idx, input ) {
            var $input = $(input)
            var name = $input.attr( 'name' )
            var val = $input.val()

            var current = localStorage[ name ]

            if( val != current ) {
                localStorage[ name ] = val
                status += ( ( status.length > 0 ? '\n' : '' )
                            + '"' + name + '" set to: ' + val )
            }
        } )
        if( status.length > 0 ) {
            // ToDo: Generate HTML <ul/>
            // http://www.chromium.org/developers/design-documents/desktop-notifications/api-specification
            //webkitNotifications.createHTMLNotification( 'notification.html' )
            
            // ToDo: Move to definitions file
            webkitNotifications,__defineGetter__(
                'allowed',
                function() {
                    webkitNotifications.ALLOWED = webkitNotifications.ALLOWED || 0
                    return webkitNotifications.checkPermission() == webkitNotifications.ALLOWED
                } )

            if( webkitNotifications.allowed )
                var notification = webkitNotifications.createNotification(
                    chrome.extension.getURL( 'icon/48/png' ),
                    'Property Changed',
                    status
                )
                notification.show()
                    
                setTimeout( function() {
                    notification.cancel()
                }, 10000 )
            }
        }
        return false
    }

    $('form').submit( save )
} )
