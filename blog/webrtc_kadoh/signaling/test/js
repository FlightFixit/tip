$( function() {
    var connections = {} // connections[uuid] = RTCPeerConnection
    var channels = {}
    var servers = null // Used in creating peer connections

    var server = new SimpleSignaling( {
        // ws_uri: 'ws://simplesignaling-piranna.dotcloud.com'
        ws_uri: 'ws://ec2-54-242-188-68.compute-1.amazonaws.com:8080',
        room: 'broadcast-test'
    } )

    trace( "Created server: " + server.uid() )

    server.onmessage = function( msg, uid, room ) {
        trace( 'onmessage', arguments )
        if( msg.type == 'offer' ) {
            onoffer( msg, uid )
        } else if( msg.candidate ) {
            trace( 'Remote ICE candidate', msg )
            connections[uid].addIceCandidate( msg.candidate )
        } else {
            console.warn( 'server.onmessage: Unknown message type', msg )
        }
    }

    function onoffer( offer, uid ) {
        connections[uid] = new webkitRTCPeerConnection( servers,
                                                        { optional: [{ RtpDataChannels: true }] } )
        
        function gotRemoteDescription( desc ) {
            connections[uid].setLocalDescription( desc )
            //connections[uid].setRemoteDescription( desc )
            server.send( desc, uid, server.room() )
            trace( "Answer from: " + uid, desc )
        }
            
        connections[uid].createAnswer( gotRemoteDescription )

        function gotReceiveChannel( event ) {
            trace( "Receive Channel Callback: " + uid )
            channels[uid] = event.channel

            function handleMessage( event ) {
                trace('Received message from: ' + uid, event.data )
            }
            
            channels[uid].onmessage = handleMessage


            function handleReceiveChannelStateChange() {
                var readyState = channels[uid].readyState;
                trace( "Receive channel state is: " + readyState )
            }

            channels[uid].onopen = handleReceiveChannelStateChange
            channels[uid].onclose = handleReceiveChannelStateChange
        }
    
        connections[uid].ondatachannel = gotReceiveChannel
    }

    var pubnub = PUBNUB.init( {
        publish_key   : 'pub-c-53cbf79b-27de-4cf9-999f-5e4d5ae417aa',
        subscribe_key : 'sub-c-86defc0a-d85e-11e2-b1b2-02ee2ddab7fe'
    } )

    server.onopen = function() {
        trace( 'onopen', arguments )
        pubnub.publish( {
            channel: "mimis/peer/awaken",
            message: server.uid()
        } )
    }

    server.onerror = function() {
        trace( 'onerror', arguments )
    }

    pubnub.subscribe( {
        channel : 'mimis/peer/awaken',
        message : function( msg ) {
            var dest_uid = msg
            if( server.uid() != dest_uid ) {
                trace( 'mimis/peer/awaken', dest_uid )
                onawaken( dest_uid )
            }
        },
    } )

    function onawaken( uid ) {
        var servers = null
        connections[uid] = new webkitRTCPeerConnection( servers,
                                                        { optional: [{ RtpDataChannels: true }] } )
    
        function gotCandidate( event ) {
            if( event.candidate ) {
                server.send( event.candidate, uid, server.room() )
                trace( 'Local ICE candidate', event.candidate )
            }
        }

        connections[uid].onicecandidate = gotCandidate

        try {
            // Reliable Data Channels not yet supported in Chrome
            channels[uid] = connections[uid].createDataChannel( "mimisChannel",
                                                                    { reliable: false } )
            trace( 'Created send data channel' )
        } catch (e) {
            console.error( 'Failed to create data channel. ' +
                           'You need Chrome M25 or later with RtpDataChannel enabled' )
            trace( 'createDataChannel() failed with exception: ' + e.message )
        }

        function handleSendChannelStateChange() {
            var readyState = channels[uid].readyState
            trace( "Send channel state is: " + readyState )
        }

        channels[uid].onopen = handleSendChannelStateChange
        channels[uid].onclose = handleSendChannelStateChange
        
        function gotLocalDescription( desc ) {
            connections[uid].setLocalDescription( desc )
            trace( 'Offer from: ' + uid, desc )
            server.send( desc, uid, server.room() )
        }
        
        connections[uid].createOffer( gotLocalDescription )
    }
    
    function trace() {
        var args = Array.prototype.slice.apply( arguments )
        if( typeof args[0] == 'string' ) {
            args[0] = ( performance.now() / 1000 ).toFixed( 3 ) + ': ' + args[0]
        }
        console.log.apply( console, args )
    }
} )
