//!/bin/js

mimis = typeof mimis !== 'undefined' ? mimis : {}

if( mimis.__lookupGetter__( 'id' ) === undefined ) {
    mimis.__defineGetter__( 'id', function() {
        return ( ( Math.random() * Number.MAX_VALUE )
                 .toString( 36 )
                 .substring( 0, 10 ) )
    } )
}

if( mimis.__lookupGetter__( 'out' ) === undefined ) {
    mimis.__defineGetter__( 'out', function() {
        var File = java.io.File
        //var store = File.createTempFile( 'mimis.out.', '.log' )
        var store = new File( '.mimis.out.' + mimis.id + '.log' )
        var jOut = new java.io.FileOutputStream( store )
        return {
            get stream() {
                return jOut
            },
            toString : function() {
                return readFile( store.getName() )
            },
        }
    } )
}
    
mimis.deref = mimis.deref ||
    function( link ) {
        if( typeof environment === 'undefined'
            || environment[ 'os.emulator' ] != 'cygwin' ) {
            return link
        }
        var out = mimis.out
        runCommand( 'cygpath', '-w', link,
                    { output : out.stream } )
        var path = out.toString()
        return path.substring( 0, path.length - 1 )
    }

console = typeof console !== 'undefined' ? console :
    {
        log : print,
        debug : print,
        error : print,
    }

// Symlinks don't work in the jvm
// ToDo: Mirror fs & load from mapping
console.log( mimis.deref( '.../lib/mimis/js' ) )
load( mimis.deref( '.../lib/mimis/js' ) )

console.log( mimis.load )

//console.log( environment[ 'os.emulator' ] )

;( function() {
    var File = java.io.File

    function toString( file ) {
        var FileInputStream = java.io.FileInputStream
        var Reader = java.io.Reader
        var BufferedReader = java.io.BufferedReader
        var InputStreamReader = java.io.InputStreamReader
        var StringBuffer = java.lang.StringBuffer

        var stream = new FileInputStream( file )
        try {
            var charset =
                java.nio.charset.Charset.availableCharsets().get( 'UTF-8' )
            var reader = new BufferedReader(
                new InputStreamReader( stream, charset )
            )
            var builder = new StringBuffer()
            var buffer = new Array( 8192 )
            var read
            while( ( read = reader.read( buffer, 0, buffer.length ) ) > 0 ) {
                builder.append( buffer, 0, read )
            }
            var ret = builder.toString()
            console.log( '!:' + ret )
            return ret
        } finally {
            stream.close()
        }
    }

    try {
        var Connection = java.sql.Connection
        var server = mimis.load( '.../work/ssis/server/mimis' )

        console.log( server )

        return

    var DriverManager = java.sql.DriverManager

    try {
        java.lang.Class.forName( 'com.microsoft.sqlserver.jdbc.SQLServerDriver' ).newInstance()
        console.log( '!' )
        var con =
            DriverManager.getConnection( server.uri, server.user, server.pass )
        if( con != null ) {
            console.log( 'Connected: ' + server.uri )

            var meta = con.getMetaData()
            console.log( 'Driver Information:' )
            console.log( "\tDriver Name:" + meta.getDriverName() )
            console.log( "\tDriver Version:" + meta.getDriverVersion() )
            console.log( 'Database Information:' )
            console.log( "\tDatabase Name: " + meta.getDatabaseProductName() )
            console.log( "\tDatabase Version: " + meta.getDatabaseProductVersion() )

            var cats = meta.getCatalogs()
            console.log( 'Avalilable Catalogs:' )
            while( cats.next() ) {
                console.log( "\tCatalog: "+ cats.getString( 1 ) )
            } 
            cats.close()

            con.close()
        }
    } catch( e ) {
        console.error( 'Error Connecting: ' + e )
    }

    var neo4j = mimis.load( '.../lib/mimis/neo4j/mimis' )
    var db = new neo4j.Database( 'tmp/xls/neo4j/' )

    var tx = db.mk.tx
    try {
        var xls = mimis.load( '.../lib/mimis/xls/rhino' )
        var workbook = new xls.Workbook( 'test.xlsx' )
        var node = { workbook : db.mk.node }
        var rel = { workbook : db.mk.rel( 'workbook' ) }
        db.ref.rel.to( node.workbook, rel.workbook )
        workbook.sheets.each( function( sheet ) {
            node.sheet = db.mk.node
            node.workbook.rel.to( node.sheet, rel.workbook )
            node.workbook.rel.to( node.sheet, db.mk.rel( 'sheet' ) )
            sheet.rows.each( function( row ) {
                node.row = db.mk.node
                node.sheet.rel.to( node.row, rel.workbook )
                node.sheet.rel.to( node.row, db.mk.rel( 'row' ) )
                node.row.prop( 'num', row.num )
                row.cells.each( function( cell ) {
                    node.cell = db.mk.node
                    node.row.rel.to( node.cell, rel.workbook )
                    node.row.rel.to( node.cell, db.mk.rel( 'cell' ) )
                    node.cell.prop( 'val', cell )
                } )
            } )
        } )

        db.ref.traverse( { rel : rel.workbook } )
            .each( function( node ) {
                console.log( node )
            } )
        tx.success
    } finally {
        tx.finish
    }

    db.shutdown
} catch ( ioe ) {
    console.log( ioe )
}

} )()
