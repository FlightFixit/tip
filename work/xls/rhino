//!/bin/js

load( '.../lib/mimis/js' )

var xls = mimis.load( '.../lib/mimis/xls/rhino' )
var neo4j
var EmbeddedGraphDatabase = org.neo4j.kernel.EmbeddedGraphDatabase
var DynamicRelationshipType = org.neo4j.graphdb.DynamicRelationshipType

try {
    var dbPath = 'tmp/xls/neo4j/'
    var db = ( function() {
        var db = new EmbeddedGraphDatabase( dbPath )
        return (
            ( function() {
                var ret = {
                    node : {},
                    get shutdown() {
                        return db.shutdown()
                    },
                    tx : {},
                }
                ret.node.__defineGetter__( 'new', function() {
                    var node = db.createNode()
                    return {
                        relTo : function() {
                            arguments[0] && arguments[0].node && ( arguments[0] = arguments[0].node )
                            var rel = node.createRelationshipTo.apply( node, arguments )
                            return {
                                prop : function() {
                                    return rel.setProperty.apply( rel, arguments )
                                },
                            }
                        },
                        prop : function() {
                            return node.setProperty.apply( node, arguments )
                        },
                        get node() {
                            return node
                        },
                        valueOf : function() {
                            return node
                        },
                    }
                } )
                ret.tx.__defineGetter__( 'new', function() {
                    var tx = db.beginTx()
                    return {
                        get success() { return tx.success() },
                        get finish() { return tx.finish() },
                    }
                } )
                return ret
            } )()
        )
    } )()
    
    var mkrel = DynamicRelationshipType.withName

    var tx = db.tx['new']
    try {
        var nodes = [ db.node['new'], db.node['new'] ]
        var rel = nodes[0].relTo( nodes[-1], mkrel( 'knows' ) )
    
        nodes[0].prop( 'message', 'Hello, ' )
        nodes[-1].prop( 'message', 'world!' )
        rel.prop( 'message', 'brave neo' )
        tx.success
    } finally {
        tx.finish
    }
    db.shutdown

    var workbook = new xls.Workbook( 'test.xlsx' )
    var sheet = workbook.sheet[ 0 ]

    sheet.rows.each( function( row ) {
        console.log( 'Row #' + row.num )
        row.cells.each( function( cell ) {
            console.log( 'Cell: ' + cell )
        } )
    } )
} catch ( ioe ) {
    console.log( ioe )
}
