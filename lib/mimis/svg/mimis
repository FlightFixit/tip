if( mimis.$root.__lookupGetter__( 'viewBox' ) === undefined ) {
    mimis.$root.__defineGetter__(
        'viewBox',
        function() {
            var attr = $(this).attr( 'viewBox' ) || '0 0 100 100'
            var split = attr.split( ' ' )
            // ToDo: handle unset viewBox
            return {
                x : mimis.parse.position( split[0] ),
                y : mimis.parse.position( split[1] ),
                width  : mimis.parse.length( split[2] ),
                height : mimis.parse.length( split[3] ),
            }
        } )
}

if( mimis.$root.__lookupSetter__( 'viewBox' ) === undefined ) {
    mimis.$root.__defineSetter__(
        'viewBox',
        function( box ) {
            box =
                mimis.x( mimis.$root.viewBox,
                         box )
            var vals = [
                box.x, box.y, box.width, box.height
            ]
            mimis.$root.attr( {
                viewBox : vals.join( ' ' )
            } )
            return box
        } )
}

if( mimis.$root && mimis.$root.viewBox ) {
    ( function() {
        var initialBox

        mimis.scroll = mimis.scroll || {}
        
        // ToDo: Allow mode changes to stick without key holding

        mimis.$root.bind( 'mousewheel', function( evt ) {
            // Zoom in or out, keeping the location under the pointer fixed
            var box = mimis.$root.viewBox
            initialBox = initialBox || box
            var imp = mimis.scroll.imp || .1
            imp *= evt.wheelDelta / -120 // One scroll
            
            function transform() {
                if( evt.shiftKey ) {
                    if( evt.ctrlKey ) {
                        return { y : box.y + box.width * imp }
                    } else {
                        return { x : box.x + box.height * imp }
                    }
                } else {
                    var delta = {
                        width  : box.width * imp,
                        height : box.height * imp,
                    }
                    // Needs to be the percentage across the image
                    var pos = {
                        x : evt.clientX / window.innerWidth,
                        y : evt.clientY / window.innerHeight,
                    }
                    
                    return {
                        x : box.x - delta.width * pos.x,
                        y : box.y - delta.height * pos.y,
                        width  : box.width + delta.width,
                        height : box.height + delta.height,
                    }
                }
            }
            mimis.$root.viewBox = mimis.x( box, transform() )
        } )
    } )()
}

if( mimis.$root.__lookupGetter__( 'bbox' ) === undefined ) {
    mimis.$root.__defineGetter__(
        'bbox',
        function() {
            return mimis.$root.get(0).getBBox()
        } )
}

$.fn.bbox = $.fn.bbox ||
    function() {
        // ToDo: Handle multiple items
        var bbox = this[0].getBBox()
        return bbox
    }
