#!/bin/bash

for arg in "$@"; do
    LINK="$(readlink "$arg")"
    [[ "$arg" != "$LINK" && ! -e "$arg" ]] && {
        echo "Skip Broken Link: $arg"
        continue
    }
    [ ! -L "$arg" ] && {
        echo "Skip Non-link: $arg"
        continue
    }
    
    ENDPOINT="$MIMIS_ORIGIN"
    [ ! -e "$LINK" ] && {
        [ -z "$ENDPOINT" ] && {
            ENDPOINT="$(git remote -v | grep -e "^origin	ssh://.* (push)$" | perl -pe 's|^origin	ssh://(.+?)/.*|\1|')"
        }
        [ -z "$ENDPOINT" ] && {
            echo 'Error: No destination server found'
            exit -1
        }
        rsync "$ENDPOINT:$LINK" "$LINK"
    }
done
