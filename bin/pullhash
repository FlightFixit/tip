#!/bin/bash

#ToDo: Add getopt

HASHDIR=".../hashes/sha256/"

ENDPOINT="$MIMIS_ORIGIN"
[ -z "$ENDPOINT" ] && {
    ENDPOINT="$(git remote -v | grep -e "^origin	ssh://.* (push)$" | perl -pe 's|^origin	ssh://(.+?)/.*|\1|')"
}

[ $# == 0 ] && {
    echo "Usage: $0 [file]+"
    echo " Pulls the hashes for a list of files to:"
    echo "    A SSH endpoint of git:~/.../"
    echo
    echo " Will call lnhash if a file is not a hash link."
    echo
    echo " pullhash ."
    [ -n "$ENDPOINT" ] && {
        echo $'\x0A'' $ENDPOINT:'$ENDPOINT
    }
    exit -2
}

[ -z "$ENDPOINT" ] && {
    echo 'Error: No destination server found'
    exit -1
}

for arg in "$@"; do
    [ -z "$arg" ] && continue

    # Too many levels of symbolic links    
    # LINK="$(readlink -f "$arg")"
    LINK="$arg"
    while [ "$LINK" != "$(readlink "$LINK")" ]; do
        LINK="$(readlink "$LINK")"
    done

    LINK="${LINK#$(echo ~)/}"

    [[ ! -z "$LINK" && ! -e "$LINK" ]] && {
        [ -z "$VERBOSE" ] || echo "Pulling: $arg ($LINK)"
        rsync --progress "$ENDPOINT:$LINK" "$LINK"
        continue
    }
    
    [[ "$arg" != '.' && "$arg" != '..' && "$arg" != '...' \
        && -d "$arg" && $(ls -1 "$arg" | wc -l) -gt 0 ]] && {
        arg="${arg%/}/"
        [ -z "$VERBOSE" ] || echo "Descending Into: $arg"
        pullhash "$arg"*
        continue
    }

    [[ ! -z "$LINK" && -d "$LINK" ]] && {
        [ -z "$VERBOSE" ] || echo "Skipping Dir Link: $arg"
        continue
    }

    [[ ! -z "$LINK" && -f "$LINK" ]] && {
        [ -z "$REALLY_VERBOSE" ] || echo "Skipping File Link: $arg"
        continue
    }

    [ ! -z "$LINK" ] && {
        [ -z "$VERBOSE" ] || echo "Skipping Link: $arg"
        continue
    }

    [ -z "$REALLY_VERBOSE" ] || echo "File: $arg"
done

# for arg in "$@"; do
#     LINK="$(readlink "$arg")"

#     ENDPOINT="$MIMIS_ORIGIN"
#     [[ ! -z "$LINK" && ! -e "$LINK" ]] && {
#         [ -z "$ENDPOINT" ] && {
#             ENDPOINT="$(git remote -v | grep -e "^origin	ssh://.* (push)$" | perl -pe 's|^origin	ssh://(.+?)/.*|\1|')"
#         }
#         [ -z "$ENDPOINT" ] && {
#             echo 'Error: No destination server found'
#             exit -1
#         }
#         echo "Pulling: $arg"
#         rsync "$ENDPOINT:$LINK" "$LINK"
#     }
# done
