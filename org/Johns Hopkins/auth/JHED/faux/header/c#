using System;
using System.Data;
using System.Configuration;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using System.Collections.Specialized;
using System.Reflection;

/// <summary>
/// Adds JHED id to request headers to requests on a development server
/// </summary>
public class AddJHEDHeaders : IHttpModule
{
    String username = "hsong3";

    public AddJHEDHeaders() {}

    public void Init(HttpApplication application) {
        application.BeginRequest += (new EventHandler(this.BeginRequest));
    }

    private void BeginRequest(Object source, EventArgs e) {
        HttpApplication app = (HttpApplication)source;
        HttpRequest Request = (HttpRequest)app.Context.Request;

        NameValueCollection headers = Request.Headers;

        // This will cause the header to be inserted on the regular server when the user is not authenticated
        if (headers["JHED_uid"] == null)
        {
            Type type = headers.GetType();
            System.Collections.ArrayList item = new System.Collections.ArrayList();

            type.InvokeMember("MakeReadWrite", BindingFlags.InvokeMethod | BindingFlags.NonPublic | BindingFlags.Instance, null, headers, null);
            type.InvokeMember("InvalidateCachedArrays", BindingFlags.InvokeMethod | BindingFlags.NonPublic | BindingFlags.Instance, null, headers, null);
            item.Add(username);
            type.InvokeMember("BaseAdd", BindingFlags.InvokeMethod | BindingFlags.NonPublic | BindingFlags.Instance, null, headers, new object[] { "JHED_uid", item });
            type.InvokeMember("MakeReadOnly", BindingFlags.InvokeMethod | BindingFlags.NonPublic | BindingFlags.Instance, null, headers, null);
        }
    }

    public void Dispose() { }
}
